<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Génération de cartes en ligne personnalisées : cas des ZNT en viticulture</title>
    <meta charset="utf-8" />
    <meta name="author" content="Romain Lacroix" />
    <script src="libs/htmlwidgets/htmlwidgets.js"></script>
    <script src="libs/jquery/jquery.min.js"></script>
    <link href="libs/leaflet/leaflet.css" rel="stylesheet" />
    <script src="libs/leaflet/leaflet.js"></script>
    <link href="libs/leafletfix/leafletfix.css" rel="stylesheet" />
    <script src="libs/Proj4Leaflet/proj4-compressed.js"></script>
    <script src="libs/Proj4Leaflet/proj4leaflet.js"></script>
    <link href="libs/rstudio_leaflet/rstudio_leaflet.css" rel="stylesheet" />
    <script src="libs/leaflet-binding/leaflet.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Génération de cartes en ligne personnalisées : cas des ZNT en viticulture
### Romain Lacroix
### 14 juin 2019

---




class: center, middle


# Slides disponibles sur

## https://rxlacroix.github.io/sotmfr2019


---

# Côtes-du-Rhône

.pull-left[


- 130 000 ha de terroirs en AOC




- 171 communes de Vienne à Avignon, 6 départements, 3 régions




- 5 500 exploitations, 20 000 emplois directs


]

.pull-right[

<div id="htmlwidget-09a7096a76c55b2a2d0e" style="width:100%;height:504px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-09a7096a76c55b2a2d0e">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"http://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"http://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addTiles","args":["https://api.mapbox.com/styles/v1/sgvrcdr/cjwq5gik57u0s1cmg6n81lrcl/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1Ijoic2d2cmNkciIsImEiOiJjanBkdnplODIwMnlkM2tsZzVzdGRiMHF1In0.-b82aCWZynf5W-h2vtQXxg","AOC","AOC",{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"INAO"}]}],"setView":[[44.7,5],8,[]]},"evals":[],"jsHooks":[]}</script>

]


---

background-image: url(https://i.ibb.co/JBc3FPG/znt.png)
background-size: 666px
background-position: 50% 45%

# Le problème : Zones Non Traitées (ZNT)

Loi du 4 mai 2017

&lt;center&gt;

&lt;div style="margin-bottom:280px;"&gt;
&lt;/div&gt;

**Points d'eau**

** \+ **

**Établissements accueillant des personnes vulnérables**

&lt;/center&gt;
.footnote[
© Reinach
]

---
&lt;div style="margin-bottom:10px;"&gt;
&lt;/div&gt;
.pull-left[
- ** [https://ephy.anses.fr/](https://ephy.anses.fr/) **


- ** ZNT : 5, 20 ou 50m pour la viticulture **
]
.pull-right[
![](https://www.agro.basf.fr/Pictures/pictures_fr/produits/bidons/bidon_wing_p_1540x866.jpg)
]
&lt;div style="margin-bottom:0px;"&gt;
&lt;/div&gt;

### Exemple : Glyphosate (Rival Pro)

![](https://i.ibb.co/MSjR0c4/Screenshot-from-2019-06-10-13-12-43.png)

---

background-image: url(https://i.ibb.co/VDypZhm/zntlaudunddt.png)
background-size: 666px
background-position: 50% 57%

# Point de départ 

.footnote[©DDT 30]

---

# Règlementation

.pull-left[
## ZNT Eau
- Le cours d'eau doit être classé "ZNT"


- Le cours d'eau doit être classé "cours d'eau"


- +/- Négociation départementale


- Pas de données fournies simplement


- Pas de lits mineurs indiqués


]


.pull-right[
## ZNT Pers. Vulnérables
- Enfants + Malades + Handicapés + Pers. âgées

- Pas d'exhaustivité des lieux concernés

]

---

# Une solution

Stratégie du syndicat des CDR de conversion de ses exploitations vers des modes de production plus respectueux des environnements. 


Production automatisée de cartes interactives personnalisées pour chaque exploitation viticole leur permettant de situer leurs parcelles au regard des différentes ZNT :

--

1. Retravailler les ZNT eau pour avoir une précision et une compréhension acceptable à l'échelle 1:1

--

1. Établir une cartographie des ZNT Pers. Vuln. pour les Côtes-du-Rhône à l'aide d'**OpenStreetMap**

--

1. Intégrer ces éléments dans un processus automatisé de cartographie interactive &amp; personnalisée

---


# ZNT Eau

En théorie : on considère points d'eau / cours d'eau ZNT tous les éléments hydrographiques présents sur les cartes topo IGN 1:25000 (bleu)

1. Utilisation de la BD Topo Hydro (IGN)

    - SURFACES_EAU : polygones

    - TRONCONS_EAU : lignes

1. Pour les départements avec négociation des cours d'eau : retrait des cours d'eau non-ZNT

1. Pas de lit mineur : tampon de 50 cm pour chaque élément

1. Tampons de 5m, 20m et 50m : fusions, nettoyages, conversion en tuiles (Mapbox)




---

# ZNT Personnes Vulnérables = 20m autour des limites 

Pas de liste exhaustive, il a donc fallu en faire une pertinente à l'aide des clés/valeurs d'objets OSM:
.pull-left[
- Enfants :

        
        "amenity" = 'school'
        
        "amenity" = 'kindergarten'
        
        "amenity" = 'college'
        

- Santé :

        
        "amenity" = 'clinic'
        
        "amenity" = 'hospital'
        
        "amenity" = 'nursing_home'
        
        "amenity" = 'social_facility'
]

.pull-right[
- Loisirs / Sports :

        "leisure" = 'playground'
        "leisure" = 'pitch'
        "leisure" = 'picnic_table'
        "leisure" = 'park'
        "leisure" = 'sports_centre'
        "leisure" = 'garden'
]
        
        
---

# ZNT Pers. Vulnéralbes (extraction)


```r
library(osmdata)
library(sf)
library(tidyverse)

# cadastre Etalab
cadastre &lt;- st_read("cadastre.gpkg") 
# zone d'intérêt
cdr &lt;- st_read("communes_cdr.gpkg")
# requête OSM
school &lt;- st_bbox(cdr) %&gt;% 
  opq() %&gt;% 
  add_osm_feature("amenity", "school") %&gt;% 
  osmdata_sf() %$% 
  osm_points %&gt;%
  st_intersection(cadastre)
# jointure avec le cadastre et tampon 20m
znt_school &lt;- subset(cadastre, 
               cadastre$code_complet %in% school$code_complet) %&gt;%
  st_buffer(20)%&gt;%
  st_union()
```

\+ Nettoyage \+ Conversion en tuiles (Mapbox)
---
class: inverse, middle, center
background-image: url(https://i.ibb.co/80zCcSC/Screenshot-8.png)
background-size: cover


---
# Sortie ZNT

<div id="htmlwidget-66b0dd126cc56a4219d3" style="width:100%;height:504px;" class="leaflet html-widget"></div>
<script type="application/json" data-for="htmlwidget-66b0dd126cc56a4219d3">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"http://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"http://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addTiles","args":["https://api.mapbox.com/styles/v1/romainlacroix/cjuatc1zu1pgp1fnt5ayvjjpr/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1Ijoicm9tYWlubGFjcm9peCIsImEiOiJjaWY2bGFkdW4wMDY5c3VrcDgyanZib3diIn0.9QZEwFfG1GLHmtJw-oeoQA","AOC","AOC",{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false}]},{"method":"addLegend","args":[{"colors":["#BD0026","#F03B20","#FEB24C"],"labels":["5m","20m","50m"],"na_color":null,"na_label":"NA","opacity":0.8,"position":"bottomright","type":"unknown","title":"ZNT Cours eau","extra":null,"layerId":null,"className":"info legend","group":"ZNT"}]},{"method":"addLegend","args":[{"colors":["yellow"],"labels":["20m"],"na_color":null,"na_label":"NA","opacity":0.8,"position":"bottomright","type":"unknown","title":"ZNT Pers. Vuln.","extra":null,"layerId":null,"className":"info legend","group":"ZNT"}]}],"setView":[[43.95,4.76],13,[]]},"evals":[],"jsHooks":[]}</script>




---

background-image: url(https://i.ibb.co/wM2M14j/cvi.png)
background-size: 470px
background-position: 50% 90%
# Injection des données des viticulteurs

- Casiers Viticoles Informatisés (Douanes) : parcellaire planté de chaque exploitation viticole + Jointure cadastrale

- Une exploitation, un identifiant, une couche de polygones (parcellaire)


---
# Fonctionnalités

.pull-left[
- Géolocalisation

- Mesures (surfaces / distance)

- Carto du cadastre

- Carto des délimitations des aires AOC

- Vue satellite + couche labels OSM 

]

.pull-right[
![](https://i.ibb.co/MkHKj8n/mix2.png)
]

![](https://i.ibb.co/HFc3Tkn/mix1.png)

---
 
# Aperçu du script R


```r
Packages &lt;- c("tidyverse", "sf", "leaflet", "htmlwidgets",
              "webshot","htmltools","leafem","leaflet.extras")

[...]

 m &lt;- leaflet(options = leafletOptions(zoomControl = TRUE)) %&gt;%
          addTiles(Satellite, group = "Satellite") %&gt;%
          addTiles(LabelsOsm, group = "Satellite")%&gt;%
          addTiles(CadastreIGN, group = "Cadastre") %&gt;%
          addTiles(ZNT, group = "ZNT") %&gt;%
          addTiles(AOC, "INAO", group = "AOC") %&gt;%
          addPolygons(data = geo_cvi, 
                      popup = label, group = "Parcelles") %&gt;%
          addScaleBar(position = "bottomleft") %&gt;%
          addLayersControl() %&gt;%
          leafem::addHomeButton(extent(geo_cvi), 
                            "Zoom initial") %&gt;%
```


---

# Aperçu du script R


```r
...
%&gt;%
      addMeasure(
        position = "topright",
        primaryLengthUnit = "meters",
        primaryAreaUnit = "hectares",
        localization = "fr",
      ) %&gt;%
      addControlGPS()%&gt;%
      activateGPS()

    
    saveWidget(m, file = paste0(CVIt, ".html"), 
               title = paste0("Carto-", CVIt), 
*              selfcontained = TRUE)
```

---


# Aperçu de la sortie
![](https://i.ibb.co/x7h3Dj8/sortie.png)


---
background-image: url(https://i.ibb.co/ZVMyymw/espaceperso.png)
background-size: 100%
background-position: 50% 90%

# Livraison aux exploitations viticoles

- Espace perso du syndicat : en téléchargement 

- ~800 ko léger, partageable, *responsive* (téléphones)





---
# Suites

- Quantification des surfaces et des opérateurs impactés

![](https://i.ibb.co/MGCSSpf/zntstat.png)

- Ajout de nouvelles couches : Zone de traitement flavescence dorée, Météo, etc.

---
class: center, middle
background-image: url(https://www.syndicat-cotesdurhone.com/static/img/logo_scrv.jpg)
background-size: 200px
background-position: 50% 90%


# Merci pour votre attention !

Slides .Rmd créées avec le paquet R [**xaringan**](https://github.com/yihui/xaringan).
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
